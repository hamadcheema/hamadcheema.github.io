<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DevChat - Login</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f4f9;margin:0;padding:0;display:flex;justify-content:center;align-items:center;height:100vh}
    .box{background:#fff;padding:20px;border-radius:10px;box-shadow:0 8px 26px rgba(0,0,0,0.1);width:100%;max-width:350px}
    h2{text-align:center;margin:0 0 15px;color:#042a57}
    input{width:100%;padding:10px;margin-bottom:10px;border-radius:6px;border:1px solid #ddd;font-size:14px}
    button{width:100%;padding:10px;border:none;border-radius:6px;background:#042a57;color:#fff;font-weight:600;cursor:pointer;margin-bottom:10px}
    .error{color:#e63946;font-size:13px;margin-bottom:10px;text-align:center}
    .toggle{text-align:center;margin-top:10px;cursor:pointer;color:#042a57;font-size:13px}
  </style>
</head>
<body>
  <div class="box">
    <h2 id="formTitle">Signup</h2>
    <div class="error" id="error"></div>
    <input id="username" placeholder="Username (only for signup)" />
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button id="submitBtn">Signup</button>
    <div class="toggle" id="toggleForm">Already have an account? Login</div>
  </div>

  <script type="module">
    import { initializeApp } from "firebase/app";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "firebase/auth";
    import { getDatabase, ref, set, get, child } from "firebase/database";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBHQyKuiAgi831qANOkkWTNprdW1Pq6rbA",
      authDomain: "devchatbyhamad.firebaseapp.com",
      databaseURL: "https://devchatbyhamad-default-rtdb.firebaseio.com",
      projectId: "devchatbyhamad",
      storageBucket: "devchatbyhamad.appspot.com",
      messagingSenderId: "798871184058",
      appId: "1:798871184058:web:c735bea9756f8109149883"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const usernameInput = document.getElementById("username");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const submitBtn = document.getElementById("submitBtn");
    const errorEl = document.getElementById("error");
    const toggleForm = document.getElementById("toggleForm");
    const formTitle = document.getElementById("formTitle");

    let isSignup = true;

    toggleForm.addEventListener("click", () => {
      isSignup = !isSignup;
      formTitle.textContent = isSignup ? "Signup" : "Login";
      submitBtn.textContent = isSignup ? "Signup" : "Login";
      toggleForm.textContent = isSignup ? "Already have an account? Login" : "Don't have an account? Signup";
      usernameInput.style.display = isSignup ? "block" : "none";
    });

    function validateUsername(username) {
      const regex = /^[a-zA-Z0-9]{3,}$/;
      return regex.test(username);
    }

    async function checkUsernameAvailable(username) {
      const snap = await get(child(ref(db), "usernames/" + username.toLowerCase()));
      return !snap.exists();
    }

    submitBtn.addEventListener("click", async () => {
      errorEl.textContent = "";
      const username = usernameInput.value.trim();
      const email = emailInput.value.trim();
      const password = passwordInput.value;

      if (isSignup) {
        if (!validateUsername(username)) {
          errorEl.textContent = "❌ Username must be at least 3 characters (letters/numbers only)";
          return;
        }
        const available = await checkUsernameAvailable(username);
        if (!available) {
          errorEl.textContent = "❌ Username is already taken";
          return;
        }

        try {
          const userCred = await createUserWithEmailAndPassword(auth, email, password);
          const uid = userCred.user.uid;

          await set(ref(db, "users/" + uid), { username, email });
          await set(ref(db, "usernames/" + username.toLowerCase()), uid);

          window.location.href = "App/chat.html"; // ✅ redirect
        } catch (err) {
          errorEl.textContent = "❌ " + err.message;
        }
      } else {
        try {
          await signInWithEmailAndPassword(auth, email, password);
          window.location.href = "App/chat.html"; // ✅ redirect
        } catch (err) {
          errorEl.textContent = "❌ " + err.message;
        }
      }
    });
  </script>
</body>
</html>
