<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Real Time Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f4f9;margin:0;padding:0}
    .wrap{
      max-width:860px;
      margin:0 auto;
      background:#fff;
      border-radius:10px;
      box-shadow:0 8px 26px rgba(10,20,30,0.06);
      display:flex;
      flex-direction:column;
      height:100vh;
    }
    h1{margin:0;color:#042a57;font-size:20px;text-align:center;padding:8px}
    #status{color:#333;text-align:center;font-size:14px;padding:4px}
    #messages{
      flex:1;
      overflow-y:auto;
      padding:12px;
      background:#fafbfd;
    }
    .msg-row{display:flex;gap:10px;margin-bottom:12px;align-items:flex-start}
    .avatar{width:38px;height:38px;border-radius:50%;flex:0 0 38px}
    .bubble{background:#fff;padding:10px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.03);min-width:70px;max-width:74%}
    .meta{font-weight:700;color:#042a57;margin-bottom:4px;font-size:13px}
    .time{font-weight:400;color:#666;font-size:11px;margin-left:8px}
    .chat-img{max-width:220px;border-radius:8px;display:block;margin-top:6px}
    .caption{color:#222;margin-top:4px;font-size:13px}
    .controls{display:flex;gap:6px;align-items:center;padding:8px;background:#fff;border-top:1px solid #ddd}
    #msgInput{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;font-size:14px}
    #emojiPicker{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px;max-height:120px;overflow:auto}
    #emojiPicker span{cursor:pointer;padding:6px;border-radius:6px;background:#f0f0f0;font-size:18px}
    .preview{margin-top:6px;padding:0 8px}
    .preview img{max-width:100px;border-radius:8px;display:block;margin-bottom:4px}
    .reactions {margin-top:6px; display:flex; gap:6px; align-items:center; flex-wrap:wrap}
    .reaction-btn{padding:4px 8px;border-radius:14px;background:#f6f6f6;cursor:pointer; font-size:12px}
    .reaction-btn.you{background:#dfeffd}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>💬 Chat</h1>
    <div id="status">Connecting...</div>
    <div id="messages" aria-live="polite"></div>
    <div id="compose" style="display:none">
      <div class="preview" id="imgPreview" style="display:none"></div>
      <div class="controls">
        <input id="msgInput" placeholder="Write a message"/>
        <button id="emojiToggle">😀</button>
        <input id="fileInput" type="file" accept="image/*" style="display:none" />
        <button id="imgBtn">📷</button>
        <button id="sendBtn">Send</button>
      </div>
      <div id="emojiPicker" style="display:none"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "firebase/app";
    import { getDatabase, ref, push, onChildAdded, onChildChanged, set, child, get } from "firebase/database";
    import { getAuth, onAuthStateChanged } from "firebase/auth";

    const firebaseConfig = {
      apiKey: "AIzaSyBHQyKuiAgi831qANOkkWTNprdW1Pq6rbA",
      authDomain: "devchatbyhamad.firebaseapp.com",
      databaseURL: "https://devchatbyhamad-default-rtdb.firebaseio.com",
      projectId: "devchatbyhamad",
      storageBucket: "devchatbyhamad.appspot.com",
      messagingSenderId: "798871184058",
      appId: "1:798871184058:web:c735bea9756f8109149883"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const statusEl = document.getElementById('status');
    const messagesEl = document.getElementById('messages');
    const compose = document.getElementById('compose');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const emojiToggle = document.getElementById('emojiToggle');
    const emojiPicker = document.getElementById('emojiPicker');
    const fileInput = document.getElementById('fileInput');
    const imgBtn = document.getElementById('imgBtn');
    const imgPreview = document.getElementById('imgPreview');

    let currentUser = null;
    let pendingImage = null;

    // emojis
    const emojis = ["😀","😁","😂","🤣","😊","😍","😎","😢","😡","👍","🙏","🔥","❤️","💔","🎉"];
    emojis.forEach(e=>{
      const s = document.createElement('span');
      s.textContent = e;
      s.onclick = ()=>{ msgInput.value += e; emojiPicker.style.display='none'; };
      emojiPicker.appendChild(s);
    });
    emojiToggle.addEventListener('click', ()=> {
      emojiPicker.style.display = emojiPicker.style.display==='flex'?'none':'flex';
    });

    function avatarFor(name){ 
      return `https://avatars.dicebear.com/api/identicon/${encodeURIComponent(name)}.svg`; 
    }

    // 🔑 check login
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        window.location.href="login.html"; // agar login nahi hai to redirect
        return;
      }
      statusEl.textContent="Connected";

      const snap = await get(child(ref(db),'users/'+user.uid));
      if(snap.exists()){
        const d=snap.val();
        currentUser = {
          uid:user.uid,
          username:d.username,
          avatar: avatarFor(d.username)
        };
        compose.style.display='block';
      } else {
        alert("User data missing, please signup again.");
        window.location.href="login.html";
      }

      onChildAdded(ref(db,'messages'), (snap)=> renderMessage(snap.key, snap.val()));
      onChildChanged(ref(db,'messages'), (snap)=> updateMessage(snap.key, snap.val()));
    });

    // send msg
    async function sendMessage(){
      const text = msgInput.value.trim();
      if(!text && !pendingImage) return;

      const payload = {
        uid:currentUser.uid,
        username:currentUser.username,
        avatar:currentUser.avatar,
        ts:Date.now()
      };

      if(pendingImage){
        payload.type='image';
        payload.text=pendingImage;
        pendingImage=null;
        imgPreview.style.display='none';
      } else {
        payload.type='text';
        payload.text=text;
      }

      await push(ref(db,'messages'),payload);
      msgInput.value='';
      fileInput.value='';
    }

    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // image preview
    imgBtn.addEventListener('click',()=> fileInput.click());
    fileInput.addEventListener('change', e=>{
      const file=e.target.files[0];
      if(!file) return;
      const reader=new FileReader();
      reader.onload=ev=>{
        pendingImage=ev.target.result;
        imgPreview.innerHTML=`<img src="${pendingImage}" alt="preview"/>`;
        imgPreview.style.display='block';
      };
      reader.readAsDataURL(file);
    });

    // reactions
    async function toggleReaction(msgId, emoji, prev){
      if(!currentUser) return;
      const reactRef = ref(db,`messages/${msgId}/reactions/${currentUser.uid}`);
      if(prev === emoji){
        await set(reactRef, null);
      } else {
        await set(reactRef, emoji);
      }
    }

    function renderMessage(id,msg){
      const row=document.createElement('div');
      row.className='msg-row';
      row.id='msg-'+id;

      const avatar=document.createElement('img');
      avatar.className='avatar';
      avatar.src=msg.avatar||avatarFor(msg.username);
      row.appendChild(avatar);

      const bubble=document.createElement('div');
      bubble.className='bubble';
      bubble.innerHTML=`<div class="meta">${msg.username} <span class="time">${new Date(msg.ts).toLocaleTimeString()}</span></div>`;
      if(msg.type==='image'){
        bubble.innerHTML+=`<img src="${msg.text}" class="chat-img"/>`;
        if(msg.caption) bubble.innerHTML+=`<div class="caption">${msg.caption}</div>`;
      } else {
        bubble.innerHTML+=`<div>${msg.text}</div>`;
      }

      const reactionsDiv=document.createElement('div');
      reactionsDiv.className='reactions';
      bubble.appendChild(reactionsDiv);

      row.appendChild(bubble);
      messagesEl.appendChild(row);
      messagesEl.scrollTop=messagesEl.scrollHeight;

      renderReactions(id,msg);
    }

    function updateMessage(id,msg){
      const row=document.getElementById('msg-'+id);
      if(!row) return renderMessage(id,msg);
      renderReactions(id,msg);
    }

    function renderReactions(id,msg){
      const row=document.getElementById('msg-'+id);
      if(!row) return;
      const reactionsDiv=row.querySelector('.reactions');
      reactionsDiv.innerHTML='';

      const reactions=msg.reactions||{};
      const counts={};
      let myReaction=null;

      for(const uid in reactions){
        const em=reactions[uid];
        if(!em) continue;
        counts[em]=(counts[em]||0)+1;
        if(uid===currentUser?.uid) myReaction=em;
      }

      ["👍","😂","❤️","🔥","😢","😡"].forEach(em=>{
        const btn=document.createElement('span');
        btn.className='reaction-btn';
        if(myReaction===em) btn.classList.add('you');
        btn.textContent=counts[em]?`${em} ${counts[em]}`:em;
        btn.onclick=()=>toggleReaction(id,em,myReaction);
        reactionsDiv.appendChild(btn);
      });
    }
  </script>
</body>
</html>
